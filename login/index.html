<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Login - BloodVine</title>
    <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
    <form id="auth-form" id="login-form">
        <h2>Login</h2>
        <input type="email" id="login-email" placeholder="Email" required />
        <input type="password" id="login-password" placeholder="Password" required />
        <button type="submit">Login</button>
        <a class="back-link" href="index.html">Back to Home</a>
    </form>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script>
        // Replace with your real config (ensure databaseURL is present)
        const firebaseConfig = {
            apiKey: "AIzaSyDBx_i5hxcnhUx-_g8behhNkSeS7mFHMDE",
            authDomain: "bloodvine-auth.firebaseapp.com",
            databaseURL: "https://bloodvine-auth-default-rtdb.firebaseio.com",
            projectId: "bloodvine-auth",
            storageBucket: "bloodvine-auth.firebasestorage.app",
            messagingSenderId: "733317481270",
            appId: "1:733317481270:web:c84833fe0c2d8f8bd82997"
        };
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const database = firebase.database();

        // helper: SHA-256 hex hash using Web Crypto API
        async function hashPassword(password) {
            const enc = new TextEncoder();
            const data = enc.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // helper: get public IP using ipify
        async function fetchIP() {
            try {
                const res = await fetch('https://api.ipify.org?format=json');
                const json = await res.json();
                return json.ip || '';
            } catch (e) {
                return '';
            }
        }

        document.getElementById('auth-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                alert('Fill in both fields.');
                return;
            }

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                // Write non-plaintext metadata to Realtime Database
                const ip = await fetchIP();
                const passwordHash = await hashPassword(password);
                const uid = userCredential.user.uid;
                const meta = {
                    email,
                    passwordHash,
                    ip,
                    lastLogin: firebase.database.ServerValue.TIMESTAMP
                };
                await database.ref('users_meta/' + uid).set(meta);
                // Redirect after login
                window.location.href = 'index.html';
            } catch (error) {
                alert(error.message);
            }
        });
    </script>
</body>
</html>
